// let's try this with google test
// includes and such are in /usr/

// Step 1. Include necessary header files such that the stuff your
// test logic needs is declared.
//
// Don't forget gtest.h, which declares the testing framework.

#include <stdio.h>
#include "cribbage_cpp.h"
#include "card_utils.h"
#include "gtest/gtest.h"

using namespace cardutils;
using namespace cribbage_cpp;

namespace {

    // Step 2. Use the TEST macro to define your tests.
    //
    // TEST has two parameters: the test case name and the test name.
    // After using the macro, you should define your test logic between a
    // pair of braces.  You can use a bunch of macros to indicate the
    // success or failure of a test.  EXPECT_TRUE and EXPECT_EQ are
    // examples of such macros.  For a complete list, see gtest.h.

    // TODO: init an array of these uint32s, srand with 9999, expect this sequence from my_random
    //
    // testing random first 10! seeded with 9999 ================================================================

    TEST(CardUtilsTest,VpokRandomFirst10From1337d00d) {
        //vpok random! First 10 are
        uint32_t vrandfirst[10] = { 0xC46EB208, 0xB3C52DC7, 0x661E907A, 0xB576E591, 0x3E1961BC,
            0x0C05D1EB, 0xAA513E4E, 0x57003155, 0x8C6652B0, 0x35C3464F };
        //which agree with my ancient PIC version!
        CardUtils c;
        c.v_srandom(0x1337d00d);
        for(auto j=0;j<10;j++) {
            EXPECT_EQ(c.v_random(),vrandfirst[j]);
        }
    }

    //let's do ten million random_at_mosts and see if any wander out of bounds
    //NOT CONCLUSIVE, just checks if the min and max are within the expected min-max range
    //very suggestive, though, if ten million >> expected max
    TEST(CardUtilsTest,RandomAtMost3333TenMReps) {
        uint32_t maxy = 0, minny = 0xFFFFFFFF, expmin = 0, expmax = 3333;
        CardUtils c;
        for (auto j = 0; j < 10000000; j++) {
            auto x = c.random_at_most(expmax);
            if (x < minny) minny = x;
            if (x > maxy) maxy = x;
        }
        //printf("Minny = %d, maxy = %d\n",minny, maxy);
        EXPECT_LE(maxy,expmax);
        EXPECT_GE(minny,expmin);
    }

    // card basics tests ========================================================================================

    //test that card -> string -> card works for all cards
    TEST(CardUtilsTest,StrcardCardstrAllLegit) {
        std::string cardstr;
        uint8_t outcard;
        CardUtils c;
        for(uint8_t card = 0; card < 52; card++) {
            cardstr = c.cardstring(card);
            outcard = c.stringcard(cardstr);
            //printf("%2d => %s => %2d\n",card,cardstr.c_str(),outcard);
            EXPECT_EQ(card,outcard);
        }
    }

    // shuffle test for sameness with python implementation
    TEST(CardUtilsTest,ShuffleTestFrom9999) {
        //generated by python shuffle after random seeded with 9999
        uint8_t cardorder[52] = { 15, 9, 49, 14, 22, 31, 16, 13, 0, 50, 8, 47, 28, 11, 35, 2, 1, 12, 45, 7, 21, 23, 6, 17, 34, 37,
            4, 41, 36, 40, 32, 38, 51, 19, 39, 46, 27, 10, 29, 26, 48, 33, 20, 30, 3, 44, 24, 42, 18, 25, 43, 5 };
        std::vector<uint8_t> deck(52);
        CardUtils c;
        c.v_srandom(9999);
        c.shuffle(deck);
        for(auto j = 0; j < 52; j++) EXPECT_EQ(deck[j],cardorder[j]);
        //however, we expect the DEAL to be from the right, so it'd go 9, 17, 7, 42, ...
        //in fact let's unit test that
    }

    TEST(CardUtilsTest,Deal10FromShuf9999) {
        uint8_t dealorder[10] = { 5, 43, 25, 18, 42, 24, 44, 3, 30, 20 };
        CardUtils c;
        std::vector<uint8_t> deck(52);
        c.v_srandom(9999);
        c.shuffle(deck);
        for(auto j = 0; j < 10; j++) {
            EXPECT_EQ(c.deal_card(deck),dealorder[j]);
            EXPECT_EQ(deck.size(),52-(j+1));            //clunky but sort of readable, deck shrinks by 1 per card dealt
        }
    }

    //test cut: 10 card deck from 10..19, cut at index 6
    // but... now we count from the right? so index 6 is really 6 from the end
    // python semantics are now consistent
    TEST(CardUtilsTest,DeckCutTest) {
        uint8_t postcut_deck[10] = {14, 15, 16, 17, 18, 19, 10, 11, 12, 13 };
        CardUtils c;
        std::vector<uint8_t> deck;
        deck.reserve(52);
        for(auto j=0;j<10;j++) deck.push_back(10+j);
        c.cut(deck,6);
        for(auto j=0;j<10;j++) EXPECT_EQ(deck[j],postcut_deck[j]);
   }
}

int main(int argc, char *argv[]) {
    //silly noodles

    // real testing main starts here
    ::testing::InitGoogleTest();
    RUN_ALL_TESTS();
}
